name: Deploy Backend Railway

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "saas-backend/**"
      - ".github/workflows/deploy-backend-railway.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: saas-backend

    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
      RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}
      RAILWAY_API_SERVICE_ID: ${{ secrets.RAILWAY_API_SERVICE_ID }}
      RAILWAY_WORKER_SERVICE_ID: ${{ secrets.RAILWAY_WORKER_SERVICE_ID }}
      SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          if [ -z "${RAILWAY_TOKEN}" ] || [ -z "${RAILWAY_PROJECT_ID}" ] || [ -z "${RAILWAY_ENVIRONMENT_ID}" ] || [ -z "${RAILWAY_API_SERVICE_ID}" ]; then
            echo "Missing required Railway secrets."
            echo "Required: RAILWAY_TOKEN, RAILWAY_PROJECT_ID, RAILWAY_ENVIRONMENT_ID, RAILWAY_API_SERVICE_ID"
            exit 1
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend tests
        run: pytest -q

      - name: Run migrations (optional)
        if: ${{ env.SUPABASE_DATABASE_URL != '' }}
        env:
          DATABASE_URL: ${{ env.SUPABASE_DATABASE_URL }}
        run: |
          alembic upgrade head

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy API service
        run: railway up --ci --detach --project "${RAILWAY_PROJECT_ID}" --environment "${RAILWAY_ENVIRONMENT_ID}" --service "${RAILWAY_API_SERVICE_ID}"

      - name: Deploy Worker service
        if: ${{ env.RAILWAY_WORKER_SERVICE_ID != '' }}
        run: railway up --ci --detach --project "${RAILWAY_PROJECT_ID}" --environment "${RAILWAY_ENVIRONMENT_ID}" --service "${RAILWAY_WORKER_SERVICE_ID}"
